# These instructions are for Debian etch and above.

# The standard server layout for this setup is:
# * One server that acts as the "manager" server and runs Apache2.
# * Two servers that act as the proxy servers and run OpenSIPS + MediaProxy dispatcher.
# * Any number of servers that act as MediaProxy mediaproxy processes.
# The following instructions must be matched to each server type.

# 1. Make sure OpenSIPS 1.4.x, Apache2 are installed.

aptitude install opensips-mysql-module

aptitude install libjson-perl

# 2. Unpack the software:
cd /var/www
tar xzvf ~/ccnq.tar.gz

# 3. Install dojo-release for 1.0.0 or above in the "js" subdirectory.
mkdir -p /var/www/js
cd /var/www/js
DOJO=1.0.2
wget "http://download.dojotoolkit.org/release-${DOJO}/dojo-release-${DOJO}.tar.gz"
tar xzvf dojo-release-${DOJO}.tar.gz
ln -s dojo-release-${DOJO}/ dojo
rm dojo-release-${DOJO}.tar.gz 
cd /var/www

# 4. Copy configuration.pm.orig to configuration.pm
cp configuration.pm.orig configuration.pm
# and edit configuration.pm to reflect your settings.

# 5. Create the directory for base configuration.
mkdir /var/log/opensips
chown opensips.opensips /var/log/opensips

mkdir /etc/ccn
mkdir /var/log/billing
# chown opensips.opensips /var/log/billing


mkdir /var/log/opensips
# chown opensips.opensips /var/log/opensips

# To install the new opensips.cfg to reflect the local configuration, do:
perl ./CCNQ/Proxy/bin/configure.pl

# Then follow the instructions given by the script in order
# to install the database requirements.

# Once done, edit /etc/apache2/sites-enabled/000-default
# and make sure the file reads as follows:

<Directory /var/www/>
        Options Indexes FollowSymLinks MultiViews ExecCGI
        AddHandler cgi-script .pl
        AllowOverride None
        Order allow,deny
        allow from all
</Directory>

# Edit /etc/default/opensips if the server will be running opensips.

# Note: this adds ExecCGI and a AddHandler for .pl files,
# and removes the RedirectMatch (installed by Debian by default).

# Then run:
/etc/init.d/opensips restart
/etc/init.d/apache2 restart

# Install mediaproxy
aptitude install python python-pyrad python-mysqldb
cd /usr/local
MP=2.3.2
wget http://download.ag-projects.com/MediaProxy/mediaproxy-${MP}.tar.gz
tar xzvf mediaproxy-${MP}.tar.gz 
rm mediaproxy-${MP}.tar.gz
ln -s mediaproxy-${MP}/ mediaproxy

cd /usr/local/mediaproxy
cp boot/mediaproxy.debian /etc/init.d/mediaproxy
update-rc.d mediaproxy defaults 20 90 

# Don't forget to
aptitude install bind9
# and add SRV records for the mediaproxy farm.


---------------- UPGRADE --------------

I typically use the following code fragment for upgrades; I keep a SVN
copy of the source in /usr/src/ccnq (instead of using ccnq.tar.gz above).

#!/bin/sh
cd /usr/src/ccnq
svn update
tar czf ~/ccnq.tar.gz --exclude=.svn .
# The chown is needed to keep the ssh keys working.
cd /var/www; tar xzf ~/ccnq.tar.gz; chown www-data /var/www; chmod +x /var/www/*.pl; /etc/init.d/apache2 restart; chmod +x /var/www/CCNQ/Proxy/bin/*



--------------- "account" in subscriber table -----------
This is no longer needed. If a database still uses this (none I'm aware of), do:

  INSERT INTO avpops(uuid,username,domain,attribute,value,type) SELECT username,username,'',192,account,2 FROM subscriber;
